#!/bin/bash
# Root-owned helper for IP blocking/unblocking
# To be implemented in M4
# Usage: secapp-mitigate block <IP> | secapp-mitigate unblock <IP>

ACTION=$1
IP=$2

if [[ -z "$ACTION" || -z "$IP" ]]; then
    echo "Usage: secapp-mitigate block|unblock <IP>"
    exit 1
fi

# Validate IP format
if ! [[ $IP =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo "Invalid IP format"
    exit 1
fi

case "$ACTION" in
    block)
        iptables -I INPUT -s "$IP" -j DROP
        echo "Blocked $IP"
        ;;
    unblock)
        iptables -D INPUT -s "$IP" -j DROP 2>/dev/null
        echo "Unblocked $IP"
        ;;
    *)
        echo "Unknown action: $ACTION"
        exit 1
        ;;
esac
